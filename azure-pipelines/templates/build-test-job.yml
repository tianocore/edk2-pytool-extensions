# File build-test-job.yml
#
# job template for building and testing
#
# Copyright (c) 2019, Microsoft Corporation
# SPDX-License-Identifier: BSD-2-Clause-Patent
##
parameters:
  vm_image: ''
  pypi_auth_feed: ''  # set this for a release
  root_package_folder: '' # set this to root package
  name: '' #set the job name
  codecov_enabled: false # by default, we don't do codecoverage
  extra_steps: []
  python_versions: []
      # Job Titles cannot have periods, so we iterate
      # With a map using entry.key and entry.value

jobs:
- ${{each py_ver in parameters.python_versions}}:
  - job: Build_and_Test_${{parameters.name}}_Python_${{py_ver.key}}

    workspace:
      clean: all

    pool:
      vmImage: ${{ parameters.vm_image }}

    steps:
    - template: basic-setup-steps.yml
      parameters:
        python_version: '${{py_ver.value}}'

    - ${{ parameters.extra_steps }}
    
    - template: pytest-test-steps.yml
      parameters:
        root_package_folder: ${{parameters.root_package_folder}}
        codecov_enabled: ${{parameters.codecov_enabled}}

    - template: flake8-test-steps.yml

    - template: pydocstyle-test-steps.yml
      parameters:
        root_package_folder: ${{parameters.root_package_folder}}

    - template: spell-test-steps.yml

    - template: markdown-lint-steps.yml

    - task: PythonScript@0
      inputs:
        scriptSource: 'filePath'
        scriptPath: 'BasicDevTests.py'
      displayName: 'Check basic file and folder tests'
      condition: succeededOrFailed()

    - ${{ if ne(parameters.pypi_auth_feed, '') }}:
      - template: build-publish-whl-steps.yml
        parameters:
          pypi_auth_feed: ${{parameters.pypi_auth_feed}}
