<!doctype html>
<html lang="en">

<head>
    <title>Performance Report</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.2.2/css/select.bootstrap.min.css " />
    <style>
        div.attribution {
            border: 1px solid #ddd;
            background-color: #bbb;
            padding-left: 20px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1>Firmware Performance Report</h1>
        <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#tabs-1">Basic Info</a></li>
            <li><a data-toggle="tab" href="#tabs-3">Data Table</a></li>
            <li><a data-toggle="tab" href="#tabs-2">Line Chart</a></li>
            <li><a data-toggle="tab" href="#tabs-4">Messages</a></li>
            <li><a data-toggle="tab" href="#tabs-5">About</a></li>
        </ul>
        <div class="tab-content">
            <div id="tabs-1" class="tab-pane fade in active">
                <h2>Product: <span id='ProductName'></span></h2>
                <h2>Version: <span id='ProductVersion'></span></h2>
                <h2>Date Collected: <span id='PerfRunDate'></span></h2>
            </div>
            <div id="tabs-2" class="tab-pane">
                <div style="width: 100%">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
            <div id="tabs-3" class="tab-pane">
                <h2>Performance Data</h2>
                <div class="row">
                    <div class="col-xs-3">
                        <header>Start Time Filter</header>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon1">MIN</span>
                            <input id="min" type="number" class="form-control" placeholder="min start time in ms" aria-describedby="basic-addon1">
                        </div>
                        <p></p>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon2">MAX</span>
                            <input id="max" type="number" class="form-control" placeholder="max start time in ms" aria-describedby="basic-addon2">
                        </div>
                        <p></p>
                        <p>
                            <button id="ClearStartTimeFilter" class="btn btn-danger">Clear Start Time</button>
                        </p>
                    </div>
                    <div class="col-xs-3">
                        <header>Length Filter</header>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon3">MIN</span>
                            <input id="minLength" type="number" class="form-control" placeholder="min length in ms" aria-describedby="basic-addon3">
                        </div>
                        <p></p>
                        <div class="input-group">
                            <span class="input-group-addon" id="basic-addon4">MAX</span>
                            <input id="maxLength" type="number" class="form-control" placeholder="max length in ms" aria-describedby="basic-addon4">
                        </div>
                        <p></p>
                        <p>
                            <button id="ClearLengthFilter" class="btn btn-danger">Clear Length</button>
                        </p>
                    </div>
                    <div class="col-xs-3">
                        <header>Actions</header>
                        Filters: <button id="ClearAllFilter" class="btn btn-danger">Clear All</button>
                        <p></p>
                        Table Entries: <button id="SelectAll" type="button" class="btn btn-success">Select All</button> <button id="ClearAll" class="btn btn-danger">Clear Selection</button><br />
                    </div>
                </div>
                <table id="perfdata" class="table table-striped table-bordered table-hover" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>GUID</th>
                            <th>GUID Value</th>
                            <th>Description</th>
                            <th>Start Time (ms)</th>
                            <th>Length (ms)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="tabs-4" class="tab-pane">
                <h2>Tool Messages</h2>
                <div id="messages">
                    <table id="toolmessages" class="table table-striped table-bordered table-hover" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div id="tabs-5" class="tab-pane">
                <div class="row">
                    <div class="col-xs-7">
                        <p></p>
                        <p>
                            Perf Report Template Version: <span id="PerfReportTemplateVersion">1.00</span><br />
                            Perf Report Tool Version: <span id='PerfReportToolVersion'></span><br />
                            Fpdt Parse Report Tool Version: <span id='FpdtParseReportToolVersion'></span><br />
                        </p>
                        <h3>License</h3>
                        <hr />
                        <div id="ToolLicenseContent">
                            <p>
                                <span class="copyright">Copyright (c) 2017, Microsoft Corporation</span><br />
                                <span class="license">
                                    All rights reserved. Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<br>
                                    1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.<br>
                                    2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.<br><br>

                                    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
                                    ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
                                    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
                                    IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
                                    INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
                                    BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
                                    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
                                    LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
                                    OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
                                    ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
                                </span>
                            </p>
                        </div>
                    </div>
                    <div id="AttributionListWrapper" class="col-xs-5">
                        <h3>External Licenses</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Json Data for performance measurement -->
    <script>
        var JsonData = %TO_BE_FILLED_IN_BY_PYTHON_SCRIPT%;
    </script>

    <!-- Javascript libraries -->
    <script type="text/javascript" charset="utf8" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/1.2.2/js/dataTables.select.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>

    <script>

        var MESSAGES_TABLE_OFFSET = 310;  //Space needed for other stuff besides the Messages Table
        var DATA_TABLE_OFFSET = 480;  //Space needed for other stuff besides the Messages Table

        //Add Filter for start time range
        /* Custom filtering function which will filter data in Start time between two values */
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                var min = parseFloat($('#min').val());
                var max = parseFloat($('#max').val());
                var st = parseFloat(data[4]) || 0; // use start time from data

                if ((isNaN(min) && isNaN(max)) ||
                    (isNaN(min) && st <= max) ||
                    (min <= st && isNaN(max)) ||
                    (min <= st && st <= max)) {
                    return true;
                }
                return false;
            }
        );

        /* Custom filtering function which will filter data in Length time between two values */
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                var min = parseFloat($('#minLength').val());
                var max = parseFloat($('#maxLength').val());
                var st = parseFloat(data[5]) || 0; // use length from data

                if ((isNaN(min) && isNaN(max)) ||
                    (isNaN(min) && st <= max) ||
                    (min <= st && isNaN(max)) ||
                    (min <= st && st <= max)) {
                    return true;
                }
                return false;
            }
        );


        $(document).ready(function foo() {

            //
            // Create Attribution List for all external libraries used
            //
            [
                { Title: "JQuery", Copyright: "Copyright 2017 The jQuery Foundation", Version: $.fn.jquery, LicenseType: "MIT", LicenseLink: "https://jquery.org/license/" },
                { Title: "DataTables", Copyright: "DataTables designed and created by SpryMedia Ltd Copyright 2007-2017", Version: $.fn.dataTable.version, LicenseType: "MIT", LicenseLink: "https://datatables.net/license/mit" },
                { Title: "ChartJs", Copyright: "Copyright 2017 Nick Downie", Version: "2.5.0", LicenseType: "MIT", LicenseLink: "http://www.chartjs.org/docs/latest/notes/license.html" },
                { Title: "BootStrap", Copyright: "Code and documentation copyright 2011-2017 the Bootstrap Authors and Twitter, Inc.", Version: "3.3.7", LicenseType: "MIT", LicenseLink: "https://github.com/twbs/bootstrap/blob/master/LICENSE" }
            ].forEach(function (element) {
                $("<div class='attribution'><h4>" + element.Title + "</h4><p>Version: <span class='version'>" + element.Version + "</span><br /><span class='copyright'>" +
                    element.Copyright + "</span><br />License: <a class='license' href='" + element.LicenseLink + "'>" + element.LicenseType + "</a></p></div>").appendTo("div#AttributionListWrapper");
            });

            $('#ProductName').text(JsonData.Data.Model);
            $('#ProductVersion').text(JsonData.Data.UefiVersion);
            $('#PerfRunDate').text(JsonData.Data.DateCollected);
            $('#PerfReportToolVersion').text(JsonData.Data.ReportGenVersion);
            $('#FpdtParseReportToolVersion').text(JsonData.Data.FpdtParserVersion);

            $('button#ClearAll').click(function () {
                $('table#perfdata').DataTable().rows({ selected: true }).deselect();
            });

            $('button#SelectAll').click(function () {
                $('table#perfdata').DataTable().rows({ selected: false, search: 'applied' }).select();
            });

            $('button#ClearLengthFilter').click(function () {
                $("input#maxLength").val("").change();
                $("input#minLength").val("").change();
            });
            $('button#ClearStartTimeFilter').click(function () {
                $("input#min").val("").change();
                $("input#max").val("").change();
            });

            $('button#ClearAllFilter').click(function () {
                $("input#maxLength").val("").change();
                $("input#minLength").val("").change();
                $("input#min").val("").change();
                $("input#max").val("").change();
            });

            var scatterChartData = {
                datasets: []
            };

            var colors = [
                "#ff7700",
                "#809a56",
                "#802456",
                "#80d100",
                "#8077d5",
                "#ff7756",
                "#ff0056",
                "#8024ab",
                "#007e56",
                "#009ad5",
                "#80ed80",
                "#805b56"
            ];

            // Event listener to the two range filtering inputs to redraw on input
            $('#min, #max, #minLength, #maxLength').on("change paste keyup input", function () {
                $('table#perfdata').DataTable().draw();
            });

            // Scatter chart
            window.myScatter = Chart.Scatter("canvas", {
                data: scatterChartData,
                options: {
                    title: {
                        display: true,
                        text: 'UEFI Performance Timings'
                    },
                    legend: {
                        display: false
                    },
                    scales: {
                        xAxes: [{
                            gridLines:
                            {
                                display: true
                            },
                            scaleLabel:
                            {
                                display: true,
                                labelString: 'Time since power-on (ms)'
                            }
                        }],
                        yAxes: [{
                            gridLines: {
                                display: false
                            },
                            ticks: {
                                display: false,
                                min: -1
                            }
                        }]
                    },
                    tooltips: {
                        //mode: '',
                        intersect: false,
                        displayColors: false,
                        //titleFontSize : 20,
                        callbacks: {
                            label: function (tooltipItem, chart) {
                                dataset = scatterChartData.datasets[tooltipItem.datasetIndex]
                                return dataset.label + '. Start: ' + dataset.data[0].x + 'ms Length: ' + Math.round((dataset.data[1].x - dataset.data[0].x) * 1000000) / 1000000;
                            }
                        }
                    },
                }
            });// end of Scatter chart

            //datatable
            var mTable = $('table#perfdata').dataTable({
                "aaData": JsonData.Data.TimingData,
                "bPaginate": false,
                "aaSorting": [[4, "asc"]],
                "scrollY": ($(window).height() -DATA_TABLE_OFFSET) + "px",
                "select": {
                    "style": 'os'
                },
                "aoColumnDefs": [
                    {
                        "mData": "Type",
                        "aTargets": [0]
                    },
                    {
                        "mData": "GUID",
                        "aTargets": [1]
                    },
                    {
                        "mData": "GuidValue",
                        "aTargets": [2]
                    },
                    {
                        "mData": "String",
                        "aTargets": [3]
                    },
                    {
                        "mData": "StartTime",
                        "aTargets": [4]
                    },
                    {
                        "aTargets": [5],
                        "mData": "Length"
                    }
                ] //end of column def
            }); //end of modules table

            //messages table
            var messagesTable = $('table#toolmessages').dataTable({
                "aaData": JsonData.Data.Messages,
                "bPaginate": false,
                "aaSorting": [[0, "asc"]],
                "scrollY": ($(window).height() - MESSAGES_TABLE_OFFSET) + "px",
                "aoColumnDefs": [
                    {
                        "mData": "Type",
                        "aTargets": [0]
                    },
                    {
                        "mData": "Message",
                        "aTargets": [1]
                    }
                ] //end of column def
            }); //end of modules table

            //Chart Tab activate
            $("a[href='#tabs-2']").on('shown.bs.tab', function (e) {
                scatterChartData.datasets = []

                //get selected
                Data = $("#perfdata").DataTable().rows({ selected: true }).data();

                //sort by starttime
                Data.sort(function (a, b) {
                    return parseFloat(a.StartTime) - parseFloat(b.StartTime);
                });

                //Set each one into the dataset
                Index = 0;
                while (Index < Data.length) {
                    a = Data[Index];

                    lineLabel = a.String;

                    //push into chart dataset
                    scatterChartData.datasets.push(
                        {
                            label: lineLabel,
                            borderColor: colors[Index % colors.length],
                            backgroundColor: colors[Index % colors.length],
                            fill: false,
                            data: [
                                {
                                    x: parseFloat(a.StartTime),
                                    y: Index,
                                }, {
                                    x: parseFloat(a.StartTime) + parseFloat(a.Length),
                                    y: Index,
                                }
                            ]
                        });
                    Index++;
                } //for loop
                window.myScatter.options.scales.yAxes[0].ticks.max = Index;
                window.myScatter.update();
            });

            //To support tabs and correct column width we need this change
            $('a[data-toggle="tab"][href="#tabs-3"]').on('shown.bs.tab', function (e) {
                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
            });

            //Same for messages table
            $('a[data-toggle="tab"][href="#tabs-4"]').on('shown.bs.tab', function (e) {
                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
            });

        }); //end document ready function

        //
        //To handle scroll tables adjust the height based on the window height.
        //
        $(window).resize(function() {
            var newHm = $(window).height() - MESSAGES_TABLE_OFFSET;
            $("#toolmessages_wrapper .dataTables_scrollBody").height(newHm);

            var newHd = $(window).height() - DATA_TABLE_OFFSET;
            $("#perfdata_wrapper .dataTables_scrollBody").height(newHd);
        });

    </script>
</body>
</html>
